package com.illumi.dms.controller;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import com.illumi.dms.common.Consts;import com.illumi.dms.common.utils.ValidateObjectUtil;import com.illumi.dms.model.user.DmsPayTypeView;import com.jayqqaa12.jbase.jfinal.ext.ctrl.EasyuiController;import com.jfinal.ext.route.ControllerBind;import org.slf4j.LoggerFactory;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Calendar;import java.util.List;@ControllerBind(controllerKey = "/statistic/dmspaytypeview/user",viewPath="/page/system")public class DmsPayTypeViewController extends EasyuiController {    //private static final  Logger logger = Logger.getLogger(DmsUserVewController.class);    org.slf4j.Logger logger = LoggerFactory.getLogger(DmsPayTypeViewController.class);    private static  final  SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");    public void  list(){        JSONObject josn = new JSONObject();        String starDate= getPara("startDate");        String endDate= getPara("endDate");        String sort= ValidateObjectUtil.isBlankDefault(getPara("sort"),"date");        String by= ValidateObjectUtil.isBlankDefault(getPara("by"),"desc");        String type= ValidateObjectUtil.isBlankDefault(getPara("_type"),"all");        int page = this.getParaToInt("page", 1);        int rows = this.getParaToInt("rows", 10);        if(ValidateObjectUtil.isBlank(starDate)){            Calendar calendar = Calendar.getInstance();            calendar.add(Calendar.DAY_OF_MONTH,-7);            starDate =  dateFormat.format(calendar.getTime());        }        getPara(Consts.IS_ABROAD);        StringBuffer sql = new StringBuffer("select 1 as groupid , pay_type ,sum(person_num) as person_num, sum(pay_times) as pay_times,sum(pay_sum)as pay_sum ")                .append(" from dms_pay_type_view where 1=1");        if(ValidateObjectUtil.isNotBlank(starDate)){            sql.append(" and date ").append(">= '").append(starDate).append("'");        }        if(ValidateObjectUtil.isNotBlank(endDate)){            sql.append(" and date ").append("< '").append(endDate).append("'");        }        if(ValidateObjectUtil.isNotBlank(type)){            if(type.equals("all")){                sql.append(" group by ").append(" pay_type ");            }else if(type.equals("abroad")){                sql.append(" and isabroad ").append("=").append("1");                sql.append(" group by ").append(" pay_type ");            }else {                sql.append(" and isabroad ").append("=").append("0");                sql.append(" group by ").append(" pay_type ");            }        }        long total = DmsPayTypeView.dao.getCountByWhere(String.format("( %s ) as tocount ",sql.toString()));        logger.info(String.format(">>>>>>>>>>>>>total:{%s}", JSON.toJSON(total)));        josn.put("total",total+1);        if(ValidateObjectUtil.isNotBlank(sort)){            sql.append(" order by ").append(sort).append(" ").append(by);        }        long startIndex  = (page-1)*rows;        sql.append(" limit ").append(ValidateObjectUtil.numberIsBlankDefault(startIndex-1,0,0)).append(" , ").append(rows-1);        List<DmsPayTypeView> list = DmsPayTypeView.dao.find(sql.toString());        if(ValidateObjectUtil.isNotBlank(list)){            if(!ValidateObjectUtil.numberIsNotBlank(page,1)){                //DmsUserView view0 = DmsUserView.getTodayView(type);                //list.add(0,view0);            }            for (DmsPayTypeView view : list){                logger.info(String.format(">>>>>>>>>>>>:%s钻大礼包",view.get("pay_type")));                if("other".equals(view.get("pay_type"))){                    view.put("pay_type","其它");                }                view.put("pay_type",String.format("%s钻大礼包",view.get("pay_type")));            }            josn.put("rows",list);        }else {            list = new ArrayList<>();            if(!ValidateObjectUtil.numberIsNotBlank(page,1)){                //DmsUserView view0 = DmsUserView.getTodayView(type);                //list.add(0,view0);            }            josn.put("rows",list);        }        //logger.info(String.format(">>>>>>>>>>>>>infomation:{%s}", JsonKit.toJson(josn,8)));        renderJson(josn);    }}