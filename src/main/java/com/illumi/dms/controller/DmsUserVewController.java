package com.illumi.dms.controller;import com.alibaba.fastjson.JSONObject;import com.google.gson.JsonObject;import com.illumi.dms.common.Consts;import com.illumi.dms.common.utils.ValidateObjectUtil;import com.illumi.dms.model.test_dms.DmsUserView;import com.jayqqaa12.jbase.jfinal.ext.ctrl.EasyuiController;import com.jayqqaa12.model.easyui.DataGrid;import com.jayqqaa12.model.easyui.Json;import com.jfinal.ext.route.ControllerBind;import org.apache.log4j.Logger;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Calendar;import java.util.List;@ControllerBind(controllerKey = "/statistic/dmsuserview/user",viewPath="/page/system")public class DmsUserVewController extends EasyuiController {    private static final  Logger logger = Logger.getLogger(DmsUserVewController.class);    private static  final  SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");    public void  list(){        JSONObject josn = new JSONObject();        String starDate= getPara("startDate");        String endDate= getPara("endDate");        String sort= ValidateObjectUtil.isBlankDefault(getPara("sort"),"date");        String type= ValidateObjectUtil.isBlankDefault(getPara("_type"),"all");        int page = this.getParaToInt("page", 1);        int rows = this.getParaToInt("rows", 10);        if(ValidateObjectUtil.isBlank(starDate)){            Calendar calendar = Calendar.getInstance();            calendar.add(Calendar.DAY_OF_MONTH,-7);            starDate =  dateFormat.format(calendar.getTime());        }        getPara(Consts.IS_ABROAD);        StringBuffer sql = new StringBuffer("select 1 as gpid, date ,sum(regist_user_num) as regist_user_num, sum(buyin_user_num) as buyin_user_num,sum(regist_buyin_user_num)as regist_buyin_user_num,sum(total_user_num) as total_user_num, sum(total_buyin_user_num)as total_buyin_user_num from dms_user_view where 1=1");        if(ValidateObjectUtil.isNotBlank(starDate)){            sql.append(" and date ").append(">= '").append(starDate).append("'");        }        if(ValidateObjectUtil.isNotBlank(endDate)){            sql.append(" and date ").append("< '").append(endDate).append("'");        }        if(ValidateObjectUtil.isNotBlank(type)){            if(type.equals("all")){                sql.append(" group by ").append(" date ");            }else if(type.equals("abroad")){                sql.append(" and is_abroad ").append("=").append("1");                sql.append(" group by ").append(" date ");            }else {                sql.append(" and is_abroad ").append("=").append("0");                sql.append(" group by ").append(" date ");            }        }        DataGrid<DmsUserView> dg = new DataGrid();        long total = DmsUserView.dao.getCountByWhere(String.format("( %s ) as tocount ",sql.toString()));        josn.put("total",total);        if(ValidateObjectUtil.isNotBlank(sort)){            sql.append(" order by ").append(sort).append(" desc ");        }        long startIndex  = (page-1)*rows;        sql.append(" limit ").append(startIndex).append(" , ").append(rows);        List<DmsUserView> list = DmsUserView.dao.find(sql.toString());        if(ValidateObjectUtil.isNotBlank(list)){            josn.put("rows",list);        }        renderJson(josn);    }    public void  chartdata(){        JSONObject json = new JSONObject();        StringBuffer sql = new StringBuffer("select date ,sum(regist_user_num) as regist_user_num, sum(buyin_user_num) as buyin_user_num,sum(regist_buyin_user_num)as regist_buyin_user_num,sum(total_user_num) as total_user_num, sum(total_buyin_user_num)as total_buyin_user_num from dms_user_view where 1=1");        String starDate= getPara("starDate");        if(ValidateObjectUtil.isBlank(starDate)){            Calendar calendar = Calendar.getInstance();            calendar.add(Calendar.DAY_OF_MONTH,-7);            starDate =  dateFormat.format(calendar.getTime());        }        String endDate= ValidateObjectUtil.isBlankDefault(getPara("endDate"),dateFormat.format(Calendar.getInstance().getTime()));        String type= ValidateObjectUtil.isBlankDefault(getPara("_type"),"all");        if(ValidateObjectUtil.isNotBlank(starDate)){            sql.append(" and date").append(">= '").append(starDate).append("'");        }        if(ValidateObjectUtil.isNotBlank(endDate)) {            sql.append(" and date").append("< '").append(endDate).append("'");        }        String sort= "date";        if(ValidateObjectUtil.isNotBlank(type)){            if(type.equals("all")){                sql.append(" group by ").append(" date ");            }else if(type.equals("abroad")){                sql.append(" and is_abroad ").append("=").append("1");                sql.append(" group by ").append(" date ");            }else {                sql.append(" and is_abroad ").append("=").append("0");                sql.append(" group by ").append(" date ");            }        }        sql.append(" order by ").append(sort).append(" asc");        List<DmsUserView> result= DmsUserView.dao.find(sql.toString());        if(ValidateObjectUtil.isNotBlank(result)){            List<String>  dates= new ArrayList<>(result.size());            List<String>  buyins= new ArrayList<>(result.size());            List<String>  registers= new ArrayList<>(result.size());            for(DmsUserView view : result){                dates.add(ValidateObjectUtil.isBlankDefault(view.get("date"),""));                buyins.add(ValidateObjectUtil.isBlankDefault(view.get("regist_user_num"),"0"));                registers.add(ValidateObjectUtil.isBlankDefault(view.get("buyin_user_num"),"0"));            }            json.put("xAxis.data",dates);            json.put("series.register.data",registers);            json.put("series.buyin.data",buyins);        }else{            json.put("xAxis.data",null);            json.put("series.register.data",null);            json.put("series.buyin.data",null);        }        renderJson(json);    }}